version: 0.2

phases:
  install:
    commands:
      # Print all environment variables (handy for AWS CodeBuild logs)
      - env
      - ls -la

      # Update sam to latest version
      - wget -q https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip
      - unzip -q aws-sam-cli-linux-x86_64.zip -d sam-installation
      - sudo ./sam-installation/install --update
      - rm -rf ./sam-installation  aws-sam-cli-linux-x86_64.zip

  pre_build:
    commands:
      # Copy in the package file
      - cp ${CODEBUILD_SRC_DIR_Packaged}/packaged.yaml ./

      # Check we have the required file
      - ls packaged.yaml

      # Replace App Name in template
      - echo ${SDLC}
      - |
        if expr "${SDLC}" : "staging" >/dev/null; then
          echo "SSOSync-Staging"
          sed -i 's/ ssosync/ SSOSync-Staging/g' packaged.yaml
        elif expr "${SDLC}" : "release" >/dev/null; then
          echo "SSOSync"
          sed -i 's/ ssosync/ SSOSync/g' packaged.yaml
        fi

  build:
    commands:
      # Package our application with AWS SAM
      - sam publish --template packaged.yaml

